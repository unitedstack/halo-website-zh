<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>HALO</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no, maximum-scale=1, width=device-width">
  <link rel="stylesheet" href="/assets/css/index.css" type="text/css" />
  <link rel="stylesheet" href="/assets/css/syntax.css" type="text/css" />
  <link href="/img/favicon.ico" mce_href="/img/favicon.ico" rel="icon" type="image/x-icon" />
</head>
<body>
<header class="nav-header">
  <div class="inner-center">
    <a href="/" class="halo-logo"><img src="/img/halo-logo.png"></a>
    <ul class="breadcrumb">
      <li class="item"><a href="/framework/source.html">架构</a></li>
      <li class="item"><a href="/started/started.html">快速开始</a></li>
      <li class="item"><a href="/develop/config.html">开发</a></li>
      <li class="item"><a href="/about/about.html">关于</a></li>
    </ul>
  </div>
</header>

<header class="nav-header-mobile">
  <div class="inner-center-mobile">
    <div class="header-left">
        <a href="/" class="skip" ><img src="/img/halo-logo.png" class="logo"></a>
        <div id="x-open" class="x-wrapper">
          <div class="x-1"></div>
          <div class="x-2"></div>
        </div>
    </div>
    <ul id="header-center" class="header-center">
      <li class="multi-dropdown">
        <a href="javascript:void(0)" class="firsta">
          架构
          <i class="icon-arrow-down"><img src="/img/down.png"></i>
        </a>
        <div class="dropdown-wrapper">
          <ul class="dropdown">
            <li class="multi select">
              <a href="javascript:void(0)">
                介绍
                <i class="icon-arrow-down"><img src="/img/down.png"></i></i>
              </a>
              <ul class="child-dropdown">
                <li><a href="/framework/source.html">起源</a></li>
                <li><a href="/framework/idea.html">理念</a></li>
              </ul>
            </li>
            <li class="multi">
              <a href="javascript:void(0)">
                架构
                <i class="icon-arrow-down"><img src="/img/down.png"></i></i>
              </a>
              <ul class="child-dropdown">
                <li><a href="/framework/system-framework.html">系统架构</a></li>
                <li><a href="/framework/deploy-framework.html">部署架构</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </li>
      
      <li>
        <a href="javascript:void(0)" class="firsta">
          快速开始
          <i class="icon-arrow-down"><img src="/img/down.png"></i></i>
        </a>
        <div class="dropdown-wrapper">
          <ul class="dropdown">
            <li><a href="/started/started.html">快速开始</a></li>
            <li><a href="/started/deployment.html">服务器端部署</a></li>
            <li><a href="/started/scripts.html">更多命令</a></li>
          </ul>
        </div>
      </li>

      <li class="multi-dropdown">
        <a href="javascript:void(0)" class="firsta">开发
        <i class="icon-arrow-down"><img src="/img/down.png"></i></i></a>
        <div class="dropdown-wrapper">
          <ul class="dropdown">
            <li class="multi select">
              <a href="javascript:void(0)">
                配置<i class="icon-arrow-down"><img src="/img/down.png"></i></i>
              </a>
              <ul class="child-dropdown">
                <li><a href="/develop/config.html">环境配置</a></li>
                <li><a href="/develop/mirana.html">消息推送配置</a></li>
                <li><a href="/develop/menu.html">菜单配置</a></li>
                <li><a href="/develop/model.html">应用配置</a></li>
                <li><a href="/develop/popup.html">弹窗配置</a></li>
              </ul>
            </li>
            <li class="multi">
              <a href="javascript:void(0)">开发<i class="icon-arrow-down"><img src="/img/down.png"></i></i></a>
              <ul class="child-dropdown">
                <li><a href="/develop/font-develop.html">前端开发</a></li>
                <li><a href="/develop/after-develop.html">后端开发</a></li>
              </ul>
            </li>
            <li class="multi">
              <a href="javascript:void(0)">附录</a>
              <ul class="child-dropdown">
                <li><a href="/develop/learning-materials.html">研发学习资料</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </li>

      <li>
        <a href="javascript:void(0)" class="firsta">
          关于
          <i class="icon-arrow-down"><img src="/img/down.png"></i></i>
        </a>
        <div class="dropdown-wrapper">
          <ul class="dropdown">
            <li><a href="/about/about.html">关于我们</a></li>
            <li><a href="https://www.ustack.com/">有云官网</a></li>
          </ul>
        </div>
      </li>
    </ul>
  </div>
</header>
<div class="nav-header-doc"><div class="inner-center"><p class="doc">开发配置</p></div></div>
<div class="whole-page">
  <div class="site-page-slidebar">
    <div class="site-menu">
  
    <div class="site-menu-block">
      <div class="site-menu-links">
        
          <ul >
            <p class="slidebar-title">配置</p>
            
              <li >
                <a href=../develop/config.html >环境配置</a>
              </li>
            
              <li >
                <a href=../develop/mirana.html >Mirana配置</a>
              </li>
            
              <li >
                <a href=../develop/menu.html >菜单配置</a>
              </li>
            
              <li >
                <a href=../develop/model.html >应用配置</a>
              </li>
            
              <li >
                <a href=../develop/popup.html >弹窗配置</a>
              </li>
            
          </ul>
        
          <ul >
            <p class="slidebar-title">开发</p>
            
              <li >
                <a href=../develop/font-develop.html >前端开发</a>
              </li>
            
              <li >
                <a href=../develop/after-develop.html  class="active" >后端开发</a>
              </li>
            
          </ul>
        
          <ul >
            <p class="slidebar-title">附录</p>
            
              <li >
                <a href=../develop/learning-materials.html >研发学习资料</a>
              </li>
            
          </ul>
        
      </div>
    </div>
  
</div>
    <div class="site-content">
      <h2 id="后端开发">后端开发</h2>

<p>后端的文件目录所示：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">server</span>
  <span class="o">|-</span><span class="nx">api</span>
  <span class="o">|-</span><span class="nx">boot</span>
  <span class="o">|-</span><span class="nx">config</span>
  <span class="o">|-</span><span class="nx">drivers</span>
  <span class="o">|-</span><span class="nx">helpers</span>
  <span class="o">|-</span><span class="nx">middlewares</span>
  <span class="o">|-</span><span class="nx">views</span>
</code></pre>
</div>
<h4 id="pm2">pm2</h4>

<p>pm2作为process manager，可以配置环境变量，将<code class="highlighter-rouge">server</code>目录加到环境变量中，所以在代码中使用<code class="highlighter-rouge">require('drivers')</code>便是引用server中的drivers，可以简化书写，修改文件结构时也不用改跟多相对目录。</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w"> </span><span class="s2">"env"</span><span class="err">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"NODE_PATH"</span><span class="p">:</span><span class="w"> </span><span class="s2">"server:."</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<h4 id="boot">boot</h4>

<p>node服务的入口，读取配置文件，加载中间件和子项目。</p>

<p>程序目前使用的node框架是express。<code class="highlighter-rouge">const app = express();</code>得到app；</p>

<h4 id="middlewares">middlewares</h4>

<p>这里是中间件，包含</p>

<ul>
  <li>i18n</li>
  <li>session处理</li>
  <li>错误处理</li>
  <li>…</li>
</ul>

<p>这里面的功能大多在服务启动时加载，处理每一个请求。</p>

<p>使用方式一般是在<code class="highlighter-rouge">boot</code>中，通过<code class="highlighter-rouge">app.use()</code>的方式将中间件加载进来。</p>

<h4 id="helpers">helpers</h4>

<p>包含工具性的一些功能，比如querystring，paginate等，这里的功能供其他项目调用。</p>

<h4 id="drivers">drivers</h4>

<p>此目录中包含子项目，比如数据库连接，openstackAPI封装，它们被api调用时加载。</p>

<h4 id="driversindexjs">drivers/index.js</h4>

<p>当drivers第一次被引用时，执行此文件，他的作用是遍历目录里所有的文件。然后将所有的driver组合起来，引用的方式 <code class="highlighter-rouge">const mysql = require('dirvers').mysql</code>;</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">driver</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="nx">c</span><span class="p">)).</span><span class="nx">isDirectory</span><span class="p">();</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">cloud</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="nx">c</span><span class="p">);</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">driver</span><span class="p">,</span> <span class="nx">cloud</span><span class="p">);</span>
  <span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">driver</span><span class="p">;</span>
</code></pre>
</div>

<p>每个driver是一个文件夹，文件夹中有入口<code class="highlighter-rouge">index.js</code>文件。</p>

<h2 id="api">api</h2>

<p>api目录里面都是子项目。目录结构：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">api</span>
  <span class="o">|-</span><span class="nx">index</span><span class="p">.</span><span class="nx">js</span>
  <span class="o">|-</span><span class="nx">api1</span>
    <span class="o">|-</span><span class="nx">index</span><span class="p">.</span><span class="nx">js</span>
    <span class="o">|-</span><span class="nx">api</span>
    <span class="o">|-</span><span class="nx">models</span>
    <span class="o">|-</span><span class="nx">views</span>
  <span class="o">|-</span><span class="nx">api2</span>
    <span class="o">|-</span><span class="nx">index</span><span class="p">.</span><span class="nx">js</span>
    <span class="o">|-</span><span class="nx">api</span>
    <span class="o">|-</span><span class="nx">models</span>
    <span class="o">|-</span><span class="nx">views</span>
</code></pre>
</div>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">//api/index.js</span>

<span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="nx">c</span><span class="p">)(</span><span class="nx">app</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">};</span>
</code></pre>
</div>
<h4 id="api目录">api目录</h4>

<p>在启动时加载，执行<code class="highlighter-rouge">api/index.js</code>接收app，然后去遍历所有的目录。 api下面的每个目录都是一个子项目，相互独立解耦，可以自由的增减。</p>

<h4 id="api子项目">api子项目</h4>

<p>每个项目都有入口<code class="highlighter-rouge">index.js</code>文件，他们都暴露一个函数，接收app，然后对app进行处理。 每个项目一般包含：api定义接口，controller处理业务逻辑，models定义数据库表结构。 这里结构也不固定，可能没有数据库或逻辑层很简单。</p>

      <div class="docs-prevnext">
        
          <a class="docs-prev" href="/develop/font-develop.html"><span></span> 前端开发</a>
        
        
          <a class="docs-next" href="/develop/learning-materials.html">研发学习资料 <span></span></a>
        
      </div>
    </div>
  </div>
</div>
<footer class="nav-footer">
  <div id="totop" class="totop">
    <i class="icon-arrow-up"><img src="/img/topup.png"></i>
  </div>
  <section class="sitemap">
  <div class="left">
    <a href="https://www.ustack.com" class="skip" ><img src="/img/footer-ustack-logo.png" class="ustack-logo"></a>
    <a href="/" class="skip" ><img src="/img/footer-halo-logo.png" class="halo-logo"></a>
    <p class="copyright">Copyright © 2017</p>
    <p class="underline">MIT License</p>
  </div>
  <div class="right">
    <div>
      <h5>架构</h5>
      <a href="/framework/source.html">起源</a>
      <a href="/framework/idea.html">理念</a>
      <a href="/framework/system-framework.html">系统架构</a>
      <a href="/framework/deploy-framework.html">部署架构</a>
    </div>
    <div>
      <h5>快速开始</h5>
      <a href="/started/started.html">快速开始</a>
      <a href="/started/deployment.html">服务器端部署</a>
      <a href="/started/scripts.html">更多命令</a>
    </div>
    <div>
      <h5>配置</h5>
      <a href="/develop/config.html">环境配置</a>
      <a href="/develop/mirana.html">消息推送配置</a>
      <a href="/develop/menu.html">菜单配置</a>
      <a href="/develop/model.html">应用配置</a>
      <a href="/develop/popup.html">弹窗配置</a>
    </div>
    <div>
      <h5>开发</h5>
      <a href="/develop/font-develop.html">前端开发</a>
      <a href="/develop/after-develop.html">后端开发</a>
      <a href="/develop/learning-materials.html">研发学习资料</a>
    </div>
    <div>
      <h5>公司</h5>
      <a href="/about/about.html">关于我们</a>
      <a href="https://www.ustack.com/">有云官网</a>
    </div>
  </div>
  </section>
</footer>

<footer class="mobile-footer">
  <ul>
    <li><a href="/framework/system-framework.html">架构</a></li>
    <li><a href="/started/started.html">快速开始</a></li>
    <li><a href="/develop/font-develop.html">开发</a></li>
    <li><a href="/about/about.html">关于</a></li>
    <li><a href="https://www.ustack.com/">有云官网</a></li>
  </ul>
  <div class="identification">
    <p class="copyright">Copyright © 2017</p>
    <p class="underline">MIT License</p>   
  </div>
</footer>
<script src="/js/jquery-3.2.1.min.js"></script>
<script src="/js/control.js"></script>

</body>
</html>